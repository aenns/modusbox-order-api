<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="ordersImplMain" doc:id="078a0560-b61c-47d2-937a-38fe4be54614">
		<logger level="INFO" category="${logging.category}" message="Got into impl flow"/>
		<flow-ref name="queryOrderTable" target="orderQueryResult"/>
		<choice>
			<when expression="#[sizeOf(vars.orderQueryResult) &gt; 0]">
				<flow-ref name="queryItemsTable"/>	
				<flow-ref name="displayQueryResults"/>		
			</when>	
			<otherwise>
				<flow-ref name="indicateNoResult"/>
			</otherwise>	
		</choice>	
	</sub-flow>
	<sub-flow name="queryItemsTable">
		<db:select target="itemsResult" doc:name="Select" doc:id="05b70eed-728b-4db4-b3cb-78d42db4b8ea" config-ref="Database_Config">
			<db:sql>select ITEMS.ItemID, ITEMS.ItemName, ITEMS.ItemCost, ORDITEMS.OrderItemID from OrdersDb.Items ITEMS, OrdersDb.OrderItems ORDITEMS where ORDITEMS.OrderID = :orderId and ORDITEMS.ItemID = ITEMS.ItemID</db:sql>
			<db:input-parameters><![CDATA[
      			#[{'orderId' : vars.orderId}]
    			]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="indicateNoResult">
		<logger level="INFO" category="${logging.category}" message="No results found for orderId: #[vars.orderId]"/>
		<set-variable variableName="httpStatus" value="204" />
	</sub-flow>
    <sub-flow name="queryOrderTable">
    		<db:select doc:name="Select" doc:id="05b70eed-728b-4db4-b3cb-78d42db4b8ea" config-ref="Database_Config">
			<db:sql>select ORD.OrderID, ORD.CustomerName, ORD.PlacementDate from OrdersDb.Orders ORD where ORD.OrderID = :orderId</db:sql>
			<db:input-parameters><![CDATA[
      			#[{'orderId' : vars.orderId}]
    			]]></db:input-parameters>
		</db:select>
    </sub-flow>
    <sub-flow name="displayQueryResults">
    		<ee:transform doc:name="Transform Message" doc:id="095465a9-92bd-4946-8900-8d795619051f" >
			<ee:message >
				<ee:set-payload resource="dwl/display-final-payload.dwl"/>
			</ee:message>
		</ee:transform>
    </sub-flow>
</mule>
